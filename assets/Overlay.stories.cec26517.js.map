{"version":3,"file":"Overlay.stories.cec26517.js","sources":["../../src/components/Overlay/Overlay.tsx"],"sourcesContent":["import React, {\n  cloneElement,\n  CSSProperties,\n  FC,\n  HTMLAttributes,\n  ReactElement,\n  ReactNode,\n  useCallback,\n  useEffect,\n  useRef,\n  useState\n} from 'react'\nimport { createPortal } from 'react-dom'\n\nexport interface OverlayProps extends HTMLAttributes<HTMLDivElement> {\n  className?: string\n  children?: ReactElement\n  style?: CSSProperties\n  hasMask?: boolean\n  visible?: boolean\n  onVisibleChange?: () => void\n}\n\nexport const Overlay: FC<OverlayProps> = (props) => {\n  const { children, visible: prevVisible, hasMask, onVisibleChange } = props\n\n  const [visible, setVisible] = useState(prevVisible || false)\n\n  const overlayRef = useRef(null)\n\n  useEffect(() => {\n    if ('visible' in props) {\n      setVisible(prevVisible!)\n    }\n  }, [prevVisible])\n\n  useEffect(() => {\n    if (visible) {\n      const handleMouseDown = (e: MouseEvent) => {\n        const safeNodeList = []\n\n        // 弹窗默认为安全节点\n        if (overlayRef.current) {\n          safeNodeList.push(overlayRef.current)\n        }\n\n        const clickNode = e.target\n\n        for (let index = 0; index < safeNodeList.length; index++) {\n          const node = safeNodeList[index]\n          if (node && node.contains(clickNode)) {\n            return\n          }\n        }\n\n        onVisibleChange?.(false)\n      }\n      window.addEventListener('mousedown', handleMouseDown, false)\n\n      return () =>\n        window.removeEventListener('mousedown', handleMouseDown, false)\n    }\n  }, [visible])\n\n  useEffect(() => {\n    if (visible && overlayRef.current) {\n      const handleKeyDown = (e) => {\n        if (!visible) return\n\n        if (e.keyCode === 27) {\n          onVisibleChange?.(false)\n        }\n      }\n\n      window.addEventListener('keydown', handleKeyDown, false)\n\n      return () => window.removeEventListener('keydown', handleKeyDown, false)\n    }\n  }, [visible && overlayRef.current])\n\n  // 痰喘挂在 第一次 mount  node=真是dom 卸载的时候 node=null\n\n  const overlayRefCallback = useCallback((node) => {\n    overlayRef.current = node\n  }, [])\n\n  const child: ReactElement | undefined = React.Children.only(children)\n\n  const newChildren = cloneElement(child, {\n    ref: overlayRefCallback\n  })\n\n  const content = createPortal(newChildren, document.body)\n\n  if (!visible) return null\n\n  return (\n    <div>\n      {hasMask ? <div></div> : null}\n      {content}\n    </div>\n  )\n}\n\nexport default Overlay\n"],"names":["Overlay","__name","props","children","prevVisible","hasMask","onVisibleChange","visible","setVisible","useState","overlayRef","useRef","useEffect","handleMouseDown","e","safeNodeList","clickNode","index","node","window","handleKeyDown","overlayRefCallback","useCallback","child","React","newChildren","cloneElement","content","createPortal","_jsxs","_jsx"],"mappings":"+TAuBO,MAAAA,EAAAC,EAAAC,GAAA,CACL,KAAA,CAAM,SAAAC,EAAEA,QAAAA,EAAmBC,QAAAA,EAAaC,gBAAAA,CAASC,EAAAA,EAEjD,CAAAC,EAAAC,CAAA,EAAAC,EAAAA,QAAAA,SAAAL,GAAA,EAAA,EAEAM,EAAAC,iBAAA,IAAA,EAEAC,EAAAA,QAAAA,UAAAA,IAAAA,CACE,YAAAV,GACEM,EAAAA,CAAAA,CACF,EAAA,CAAAJ,CAAA,CAAA,EAGFQ,EAAAA,QAAAA,UAAAA,IAAAA,CACE,GAAAL,EAAA,CACE,MAAAM,EAAAZ,EAAAa,GAAA,CACE,MAAAC,EAAA,CAAA,EAGAL,EAAA,SACEK,EAAAA,KAAAA,EAAAA,OAAAA,EAGF,MAAAC,EAAAF,EAAA,OAEA,QAAAG,EAAA,EAAAA,EAAAF,EAAA,OAAAE,IAAA,CACE,MAAAC,EAAAH,EAAAE,GACA,GAAAC,GAAAA,EAAA,SAAAF,CAAA,EACE,MACF,CAGFV,GAAAA,MAAAA,EAAAA,GAAuB,EAjBzB,mBAmBAa,cAAAA,iBAAAA,YAAAA,EAAAA,EAAAA,EAEA,IAAA,OAAA,oBAAA,YAAAN,EAAA,EAAA,CACgE,CAClE,EAAA,CAAAN,CAAA,CAAA,EAGFK,EAAAA,QAAAA,UAAAA,IAAAA,CACE,GAAAL,GAAAG,EAAA,QAAA,CACE,MAAAU,EAAAnB,EAAAa,GAAA,CACE,CAAAP,GAEAO,EAAA,UAAA,KACER,GAAAA,MAAAA,EAAAA,IACF,EALF,iBAQAa,cAAAA,iBAAAA,UAAAA,EAAAA,EAAAA,EAEA,IAAA,OAAA,oBAAA,UAAAC,EAAA,EAAA,CAAuE,CACzE,EAAA,CAAAb,GAAAG,EAAA,OAAA,CAAA,EAKF,MAAAW,EAAAC,sBAAAJ,GAAA,CACER,EAAAA,QAAAA,CAAqBQ,EAAAA,CAAAA,CAAAA,EAGvBK,EAAAC,EAAA,SAAA,KAAArB,CAAA,EAEAsB,EAAAC,EAAA,QAAA,aAAAH,EAAA,CAAwC,IAAAF,CACjCA,CAAAA,EAGPM,EAAAC,EAAA,QAAA,aAAAH,EAAA,SAAA,IAAA,EAEA,OAAAlB,EAEAsB,EAAA,MAAA,CACE,SAAA,CAAAxB,EAAAyB,EAAA,MAAA,EAAA,EAAA,KAAAH,CAAA,CAEU,CAAA,EALE,IAQhB,EA/EO"}