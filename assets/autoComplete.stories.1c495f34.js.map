{"version":3,"file":"autoComplete.stories.1c495f34.js","sources":["../../src/hooks/useDebounce.tsx","../../src/hooks/useClickOutside.tsx","../../src/components/AutoComplete/autoComplete.tsx"],"sourcesContent":["// 处理防抖\n\nimport { useState, useEffect } from 'react'\n\nexport const useDebounce = (value: string, delay = 300) => {\n  const [debouncedValue, setDebouncedValue] = useState(value)\n  useEffect(() => {\n    const handler = window.setTimeout(() => {\n      setDebouncedValue(value)\n    }, delay)\n    // 当useEffect回调里面 返回一个函数的时候 代表清除，下次update的时候执行\n    return () => {\n      clearTimeout(handler)\n    }\n  }, [value, delay])\n  return debouncedValue\n}\n","// 点击其它区域，关闭下拉菜单\n\nimport { RefObject, useEffect } from 'react'\n\nexport const useClickOutside = (\n  ref: RefObject<HTMLElement>,\n  handler: (event: Event) => void\n) => {\n  useEffect(() => {\n    const listener = (event: MouseEvent) => {\n      if (!ref.current || ref.current.contains(event.target as HTMLElement)) {\n        return\n      }\n      handler(event)\n    }\n    document.addEventListener('click', listener)\n    return () => {\n      document.removeEventListener('click', listener)\n    }\n  }, [ref, handler])\n}\n","import React, {\n  ChangeEvent,\n  FC,\n  ReactElement,\n  useEffect,\n  useState,\n  KeyboardEvent,\n  useRef\n} from 'react'\n\nimport Icon from '../Icon'\n\nimport Transition from '../Transition'\n\nimport Input, { InputProps } from '../Input'\n\nimport { useDebounce } from '../../hooks/useDebounce'\n\nimport { useClickOutside } from '../../hooks/useClickOutside'\n\nimport classNames from 'classnames'\n\n/**\n * 用于处理复杂数据结构 eg:{value:'11', key:'22'}\n * 用户可自定义\n */\ninterface DataSourceObject {\n  value: string\n}\n\n/**\n * 传递一个范型 T, 默认为{}, 返回 传入的T & DataSourceObject\n */\nexport type DataSourceType<T = Record<string, unknown>> = T & DataSourceObject\n\nexport interface AutoCompleteProps extends Omit<InputProps, 'onSelect'> {\n  /**\n   *\n   */\n  fetchSuggestions: (\n    str: string\n  ) => DataSourceType[] | Promise<DataSourceType[]>\n  /**\n   * 点击选择项的回调\n   */\n  onSelect?: (item: DataSourceType) => void\n  /**\n   * 自定义模板\n   */\n  renderOptions?: (item: DataSourceType) => ReactElement\n}\n\n/**\n * > AutoComplete 输入框自动完成功能，需要输入建议/辅助提示。\n *\n * ### 引入方法\n *\n * ```js\n *\n * import { AutoComplete } from 'val-design'\n *\n * ```\n */\nexport const AutoComplete: FC<AutoCompleteProps> = (props) => {\n  const { fetchSuggestions, onSelect, value, renderOptions, ...restProps } =\n    props\n  // 输入的搜索关键字\n  const [inputValue, setInputValue] = useState((value as string) || '')\n  // 过滤之后的数据\n  const [suggestions, setSuggestions] = useState<DataSourceType[]>([])\n  // 发起异步请求之后的loading\n  const [loading, setLoading] = useState<boolean>(false)\n  // 控制高亮\n  const [highlightIndex, setHighlightIndex] = useState(-1)\n  // 操作键盘事件的时候，阻止列表再次请求\n  const triggerSearch = useRef(false)\n  // 点击其它区域，关闭列表\n  const componentRef = useRef<HTMLDivElement>(null)\n  // 防抖\n  const debouncedValue = useDebounce(inputValue, 500)\n\n  // 是否显示dropdown\n  const [showDropdown, setShowDropdown] = useState(false)\n\n  useClickOutside(componentRef, () => {\n    setSuggestions([])\n  })\n  useEffect(() => {\n    // 当value存在，更新value 和 suggestions list\n    if (debouncedValue && triggerSearch.current) {\n      const results = fetchSuggestions(debouncedValue)\n      if (results instanceof Promise) {\n        setLoading(true)\n        results.then((data) => {\n          setSuggestions(data)\n          setLoading(false)\n          if (data.length > 0) {\n            setShowDropdown(true)\n          }\n        })\n      } else {\n        setSuggestions(results)\n        setShowDropdown(true)\n      }\n    } else {\n      setSuggestions([])\n      setShowDropdown(false)\n    }\n\n    // 加载成功后取消高亮\n    setHighlightIndex(-1)\n  }, [debouncedValue])\n\n  const handleChange = (e: ChangeEvent<HTMLInputElement>) => {\n    const value = e.target.value.trim()\n    setInputValue(value)\n    triggerSearch.current = true\n  }\n\n  const handleSelect = (item: DataSourceType) => {\n    setInputValue(item.value)\n    setSuggestions([])\n    if (onSelect) {\n      onSelect(item)\n    }\n    triggerSearch.current = false\n  }\n  const highlight = (index: number) => {\n    if (index < 0) index = 0\n    if (index >= suggestions.length) {\n      index = suggestions.length - 1\n    }\n    setHighlightIndex(index)\n  }\n  const handleKeyDown = (e: KeyboardEvent<HTMLInputElement>) => {\n    switch (e.key) {\n      case 'Enter':\n        suggestions[highlightIndex] && handleSelect(suggestions[highlightIndex])\n        break\n      case 'ArrowUp':\n        highlight(highlightIndex - 1)\n        break\n      case 'ArrowDown':\n        highlight(highlightIndex + 1)\n        break\n      case 'Escape':\n        setSuggestions([])\n        break\n      default:\n        break\n    }\n  }\n\n  // render template\n  const renderTemplate = (item: DataSourceType) => {\n    return renderOptions ? renderOptions(item) : item.value\n  }\n\n  // dropdown\n  const generateDropdown = () => {\n    return (\n      <Transition\n        in={showDropdown || loading}\n        animation=\"zoom-in-top\"\n        timeout={300}\n        onExited={() => {\n          setSuggestions([])\n        }}\n      >\n        <ul\n          className={classNames({\n            'v-suggestion-list': suggestions.length > 0 || loading\n          })}\n        >\n          {loading && (\n            <div className=\"suggstions-loading-icon\">\n              <Icon icon=\"spinner\" spin />\n            </div>\n          )}\n          {suggestions.map((item, index) => {\n            const cnames = classNames('suggestion-item', {\n              'is-active': index === highlightIndex\n            })\n            return (\n              <li\n                key={index}\n                className={cnames}\n                onClick={() => handleSelect(item)}\n              >\n                {renderTemplate(item)}\n              </li>\n            )\n          })}\n        </ul>\n      </Transition>\n    )\n  }\n\n  return (\n    <div className=\"v-auto-complete\" ref={componentRef}>\n      <Input\n        {...restProps}\n        value={inputValue}\n        onKeyDown={handleKeyDown}\n        onChange={handleChange}\n      ></Input>\n      {/* {loading && (\n        <ul>\n          <Icon icon={'spinner'} spin></Icon>\n        </ul>\n      )} */}\n      {generateDropdown()}\n    </div>\n  )\n}\n\nexport default AutoComplete\n"],"names":["useDebounce","__name","value","delay","debouncedValue","setDebouncedValue","useState","useEffect","handler","window","setTimeout","clearTimeout","useClickOutside","ref","listener","event","current","contains","target","addEventListener","removeEventListener","AutoComplete","props","fetchSuggestions","onSelect","renderOptions","restProps","inputValue","setInputValue","suggestions","setSuggestions","loading","setLoading","highlightIndex","setHighlightIndex","triggerSearch","useRef","componentRef","showDropdown","setShowDropdown","results","data","handleChange","value2","handleSelect","item","highlight","index","handleKeyDown","renderTemplate","generateDropdown","_jsx","Transition","_jsxs","classNames","Icon","cnames"],"mappings":"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"}